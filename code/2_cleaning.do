/*=========================================================================
Young people and household caring in the postwar
Code author: Ivonne Lara
--------------------------------------------------------------------------
1_cleaning.do

This do file imports the ENUT raw databases and cleans them to create a 
unified database
=========================================================================*/

/*
	A - Información de identificación
	B - Condiciones de vivienda
	C - Datos del hogar
	D - Composición del hogar (37.849)
	E - Salud (148.492)
	F - Ciudado de los niños y niñas menores de 5
	G - Educación (136.767)
	H2 - Fuerza de trabajo (clasificación)
	H1 - Fuerza de trabajo (Uso del tiempo e ingresos) (123.316)
	I - Uso del tiempo (123.316) (146,190) 
*/

*******************************************
*** ENUT 2012-2013 ***
*******************************************

	* A. Vuelvo las bases dta
	foreach file in B C I D E G H1 {
		import delimited "${enut}/2012-2013/CAP_`file'_1213.txt", clear
		rename *, upper
		save "${enut}/2012-2013/cap_`file'_1213.dta", replace
	}

	import excel "${enut}/2012-2013/Dpto y Mpio_Geog_2012_2013.xlsx", sheet("Hoja1") firstrow clear
	save "${enut}/2012-2013/mun_1213.dta", replace

	* B. Pego las bases
	use "${enut}/2012-2013/cap_I_1213.dta", clear

	local data "D E G H1"
	foreach file of local data {
		merge 1:1 DIRECTORIO SECUENCIA_P ORDEN using "${enut}/2012-2013/cap_`file'_1213.dta", gen("`file'")
	}
	merge m:1 DIRECTORIO SECUENCIA_P using "${enut}/2012-2013/cap_C_1213.dta", gen(_merge8) // Agrego C
	merge m:1 DIRECTORIO using "${enut}/2012-2013/cap_B_1213.dta", gen(_merge6)
	merge m:1 DIRECTORIO using "${enut}/2012-2013/mun_1213.dta", gen(_merge7)
	
	* C. Cambio de nombre las variables para homogeneizar 
	rename (DPTO MPIO) (COD_DEPTO COD_MPIO)
	rename (P6210S1 P1124S3 P1124S4 P1124S1 P1124S2 P1149S1 P1149S2 P1148S1 P1148S2) (P6210 P1124S2A1 P1124S2A2 P1124S1A1 P1124S1A2 P6535S1A1 P6535S1A2 P6534S1 P6534S2) 
	rename (P1123S1A1 P1123S1A2 P1123S2A1 P1123S2A2 P1123S3A1 P1123S3A2 P1123S4A1 P1123S4A2 P1123S5A1 P1123S5A2 P1123S6A1 P1123S6A2 P1123S7A1 P1123S7A2 P1123S8A1 P1123S8A2 P1123S9A1 P1123S9A2) (P1113S1A1 P1113S1A2 P1113S2A1 P1113S2A2 P1111S1A1 P1111S1A2 P1112S1A1 P1112S1A2 P1111S2A1 P1111S2A2 P1110S1A1 P1110S1A2 P1110S3A1 P1110S3A2 P1110S5A1 P1110S5A2 P1110S7A1 P1110S7A2)
	rename (P1123S10A1 P1123S10A2 P1123S11A1 P1123S11A2 P1123S12A1 P1123S12A2 P1123S13A1 P1123S13A2 P1160S1 P1160S2) (P1110S8A1 P1110S8A2 P1111S3A1 P1111S3A2 P1111S4A1 P1111S4A2 P1144S6A1 P1144S6A2 P1160S1A1 P1160S1A2) 
	rename (P1143S3A1 P1143S3A2 P1136S3A1 P1136S3A2 P1136S4A1 P1136S4A2 P1129S2A1 P1129S2A2 P1130S1A1 P1130S1A2 P1130S2A1 P1130S2A2 P1130S3A1 P1130S3A2 P1130S4A1 P1130S4A2 P1127S3A1 P1127S3A2 P1121S1A2 P1121S1A3 P1121S2A2 P1121S2A3 P1121S3A2 P1121S3A3 P1127S2A1 P1127S2A2) (P1143S4A1 P1143S4A2 P1136S5A1 P1136S5A2 P1136S6A1 P1136S6A2 P6530S1A1 P6530S1A2 P1114S1A1 P1114S1A2 P1114S2A1 P1114S2A2 P1114S3A1 P1114S3A2 P1114S4A1 P1114S4A2 P1127S4A1 P1127S4A2 P1121S1D P1121S1E P1121S2D P1121S2E P1121S3D P1121S3E P1127S3A1 P1127S3A2)  

	* D. Me quedo con las variables de interés
	glo time1 "P1124S2A1 P1124S2A2 P1124S1A1 P1124S1A2 P1126S1A1 P1126S1A2 P1126S2A1 P1126S2A2 P1126S3A1 P1126S3A2 P1126S4A1 P1126S4A2 P1126S5A1 P1126S5A2 P1126S6A1 P1126S6A2 P1126S7A2 P1126S7A3 P1129S1A1 P1129S1A2 P1150S1 P1150S2 P1099S1 P1099S2 P6535S1A1 P6535S1A2 P6534S1 P6534S2 P1166S2A1 P1166S2A2 P1166S1A1 P1166S1A2 P1153S1A1 P1153S1A2 P1153S2A1 P1153S2A2 P1153S4A1 P1153S4A2 P1153S5A1 P1153S5A2 P1113S1A1 P1113S1A2 P1113S2A1 P1113S2A2 P1111S1A1 P1111S1A2 P1112S1A1 P1112S1A2 P1111S2A1 P1111S2A2 P1110S1A1 P1110S1A2 P1110S3A1 P1110S3A2 P1110S5A1 P1110S5A2 P1110S7A1 P1110S7A2 P1110S8A1 P1110S8A2 P1111S3A1 P1111S3A2 P1111S4A1 P1111S4A2 P1144S6A1 P1144S6A2 P1153S6A1 P1153S6A2 P1144S2A1 P1144S2A2 P1144S3A1 P1144S3A2 P1144S4A1 P1144S4A2 P1144S5A1 P1144S5A2 P1153S3A1 P1153S3A2 P1144S1A1 P1144S1A2 P1159S1 P1159S2 P1155S1 P1155S2 P1161S1A1 P1161S1A2 P1161S2A1 P1161S2A2 P1161S3A1 P1161S3A2 P1161S4A1 P1161S4A2 P1161S5A2 P1161S5A3 P1160S1A1 P1160S1A2 P1156S1 P1156S2 P1143S1A1 P1143S1A2 P1143S2A1 P1143S2A2 P1143S4A1 P1143S4A2 P1142S1A1 P1142S1A2 P1142S2A1 P1142S2A2 P1142S3A1 P1142S3A2 P1142S4A1 P1142S4A2 P1136S1A1 P1136S1A2 P1136S2A1 P1136S2A2 P1136S5A1 P1136S5A2 P1136S6A1 P1136S6A2 P1141S1A1 P1141S1A2 P1141S2A1 P1141S2A2 P1141S3A1 P1141S3A2 P1141S4A1 P1141S4A2 P1140S1A1 P1140S1A2 P1140S2A1 P1140S2A2 P1140S4A1 P1140S4A2 P1140S6A1 P1140S6A2 P1140S3A1 P1140S3A2 P1140S5A1 P1140S5A2 P1128S8A1 P1128S8A2 P1131S1A3 P1131S1A4 P1131S2A3 P1131S2A4 P1131S3A3 P1131S3A4 P1140S7A1 P1140S7A2 P1128S1A1 P1128S1A2 P1128S2A1 P1128S2A2 P1128S3A1 P1128S3A2 P1125S1A1 P1125S1A2 P1125S2A1 P1125S2A2 P1125S4A1 P1125S4A2 P1125S5A1 P1125S5A2 P1125S6A1 P1125S6A2 P1125S7A2 P1125S7A3 P6530S1A1 P6530S1A2 P1139S1A1 P1139S1A2 P1139S2A1 P1139S2A2 P1139S3A1 P1139S3A2 P1137S1A1 P1137S1A2 P1137S2A1 P1137S2A2 P1137S3A1 P1137S3A2 P1135S1A1 P1135S1A2 P1135S2A1 P1135S2A2 P1135S3A1 P1135S3A2 P1134S1A1 P1134S1A2 P1134S2A1 P1134S2A2 P1134S3A1 P1134S3A2 P1133S1A1 P1133S1A2 P1133S2A1 P1133S2A2 P1133S3A1 P1133S3A2 P1132S1A1 P1132S1A2 P1132S2A1 P1132S2A2 P1132S3A1 P1132S3A2 P1131S1A1 P1131S1A2 P1131S2A1 P1131S2A2 P1131S3A1 P1131S3A2 P1114S1A1 P1114S1A2 P1114S2A1 P1114S2A2 P1114S3A1 P1114S3A2 P1114S4A1 P1114S4A2 P1128S4A1 P1128S4A2 P1128S5A1 P1128S5A2 P1128S6A1 P1128S6A2 P1128S7A1 P1128S7A2 P1127S1A1 P1127S1A2 P1127S3A1 P1127S3A2 P1127S4A1 P1127S4A2 P1122S1A2 P1122S1A3 P1122S2A2 P1122S2A3 P1122S3A2 P1122S3A3 P1121S1D P1121S1E P1121S2D P1121S2E P1121S3D P1121S3E"
	keep COD_MPIO COD_DEPTO DIRECTORIO SECUENCIA_P ORDEN P7310 P1152 P6090 P6020 P6040 P6210 P425 P1176S1 P1176S2 P1176S3 P1176S4 P1176S5 P1176S6 P1176S7 P1176S9 P1176S10 P1176S11 P1176S12 REGION $time1 P1169S* P1174 P1172 P6020 P425
	gen ANNO = "2012-2013"
	
	foreach i of numlist 1/8 {
		replace P1169S`i'=0 if P1169S`i'==2
	}	

	* Municipio
	gen MUNICIPIO = COD_DEPTO + COD_MPIO
	destring MUNICIPIO REGION, replace
	drop COD_MPIO COD_DEPTO

	save "${enut}/2012-2013/ENUT_1213.dta", replace
	
*******************************************
*** ENUT 2016-2017 ***
*******************************************

	* A. Vuelvo las bases dta
	foreach file in B C I D E G H1 {
		import delimited "${enut}/2016-2017/CAP_`file'_1617.csv", clear
		rename *, upper
		save "${enut}/2012-2013/cap_`file'_1213.dta", replace
	}

	import excel "${enut}/2016-2017/Dpto y Mpio_Geog_2016_2017.xlsx", sheet("Hoja1") firstrow clear
	save "${enut}/2016-2017/mun_1617.dta", replace

	* B. Pego las bases
	use "${enut}/2016-2017/cap_I_1617.dta", clear

	local data "D E G H1"
	foreach file of local data {
   	 	merge 1:1 DIRECTORIO SECUENCIA_P ORDEN using "${enut}/2016-2017/cap_`file'_1617.dta", gen("`file'")
	}
	merge m:1 DIRECTORIO SECUENCIA_P using "${enut}/2016-2017/cap_C_1617.dta", gen(_merge8)
	merge m:1 DIRECTORIO using "${enut}/2016-2017/cap_B_1617.dta", gen(_merge6)
	merge m:1 DIRECTORIO using "${enut}/2016-2017/mun_1617.dta", gen(_merge7)

	* C. Cambio de nombre las variables para homogeneizar - parece que todas tienen el mismo nombre 
	* D. Me quedo con las variables de interés
	glo time2 "P1124S2A1 P1124S2A2 P1124S1A1 P1124S1A2 P1126S1A1 P1126S1A2 P1126S2A1 P1126S2A2 P1126S3A1 P1126S3A2 P1126S4A1 P1126S4A2 P1126S5A1 P1126S5A2 P1126S6A1 P1126S6A2 P1126S7A2 P1126S7A3 P1150S1 P1150S2 P1099S1 P1099S2 P6535S1A1 P6535S1A2 P6534S1 P6534S2 P1166S2A1 P1166S2A2 P1166S1A1 P1166S1A2 P1153S1A1 P1153S1A2 P1153S2A1 P1153S2A2 P1153S4A1 P1153S4A2 P1153S5A1 P1153S5A2 P1113S1A1 P1113S1A2 P1113S2A1 P1113S2A2 P1111S1A1 P1111S1A2 P1112S1A1 P1112S1A2 P1111S2A1 P1111S2A2 P1110S1A1 P1110S1A2 P1110S3A1 P1110S3A2 P1110S5A1 P1110S5A2 P1110S7A1 P1110S7A2 P1110S8A1 P1110S8A2 P1111S3A1 P1111S3A2 P1111S4A1 P1111S4A2 P1144S6A1 P1144S6A2 P1153S6A1 P1153S6A2 P1144S2A1 P1144S2A2 P1144S3A1 P1144S3A2 P1144S4A1 P1144S4A2 P1144S5A1 P1144S5A2 P1153S3A1 P1153S3A2 P1144S1A1 P1144S1A2 P1159S1 P1159S2 P1155S1 P1155S2 P1161S1A1 P1161S1A2 P1161S2A1 P1161S2A2 P1161S3A1 P1161S3A2 P1161S4A1 P1161S4A2 P1161S5A2 P1161S5A3 P1160S1A1 P1160S1A2 P1156S1 P1156S2 P1143S1A1 P1143S1A2 P1143S2A1 P1143S2A2 P1143S4A1 P1143S4A2 P1142S1A1 P1142S1A2 P1142S2A1 P1142S2A2 P1142S3A1 P1142S3A2 P1142S4A1 P1142S4A2 P1136S1A1 P1136S1A2 P1136S2A1 P1136S2A2 P1136S5A1 P1136S5A2 P1136S6A1 P1136S6A2 P1141S1A1 P1141S1A2 P1141S2A1 P1141S2A2 P1141S3A1 P1141S3A2 P1141S4A1 P1141S4A2 P1140S1A1 P1140S1A2 P1140S2A1 P1140S2A2 P1140S4A1 P1140S4A2 P1140S6A1 P1140S6A2 P1140S3A1 P1140S3A2 P1140S5A1 P1140S5A2 P1128S8A1 P1128S8A2 P1131S1A3 P1131S1A4 P1131S2A3 P1131S2A4 P1131S3A3 P1131S3A4 P1140S7A1 P1140S7A2 P1128S1A1 P1128S1A2 P1128S2A1 P1128S2A2 P1128S3A1 P1128S3A2 P1125S1A1 P1125S1A2 P1125S2A1 P1125S2A2 P1125S4A1 P1125S4A2 P1125S5A1 P1125S5A2 P1125S6A1 P1125S6A2 P1125S7A2 P1125S7A3 P6530S1A1 P6530S1A2 P1139S1A1 P1139S1A2 P1139S2A1 P1139S2A2 P1139S3A1 P1139S3A2 P1137S1A1 P1137S1A2 P1137S2A1 P1137S2A2 P1137S3A1 P1137S3A2 P1135S1A1 P1135S1A2 P1135S2A1 P1135S2A2 P1135S3A1 P1135S3A2 P1134S1A1 P1134S1A2 P1134S2A1 P1134S2A2 P1134S3A1 P1134S3A2 P1133S1A1 P1133S1A2 P1133S2A1 P1133S2A2 P1133S3A1 P1133S3A2 P1132S1A1 P1132S1A2 P1132S2A1 P1132S2A2 P1132S3A1 P1132S3A2 P1131S1A1 P1131S1A2 P1131S2A1 P1131S2A2 P1131S3A1 P1131S3A2 P1114S1A1 P1114S1A2 P1114S2A1 P1114S2A2 P1114S3A1 P1114S3A2 P1114S4A1 P1114S4A2 P1128S4A1 P1128S4A2 P1128S5A1 P1128S5A2 P1128S6A1 P1128S6A2 P1128S7A1 P1128S7A2 P1127S1A1 P1127S1A2 P1127S3A1 P1127S3A2 P1127S4A1 P1127S4A2 P1122S1A2 P1122S1A3 P1122S2A2 P1122S2A3 P1122S3A2 P1122S3A3 P1121S1D P1121S1E P1121S2D P1121S2E P1121S3D P1121S3E P1112S2A1 P1112S2A2 P1110S2A1 P1110S2A2 P1110S4A1 P1110S4A2 P1110S6A1 P1110S6A2 P1111S5A1 P1111S5A2 P1143S3A1 P1143S3A2 P1136S3A1 P1136S3A2 P1136S4A1 P1136S4A2 P1125S3A1 P1125S3A2 P1127S2A1 P1127S2A2"
	keep COD_MPIO COD_DEPTO DIRECTORIO SECUENCIA_P ORDEN P7310 P1152 P6090 P6020 P6040 P6210 P425 P1176S1 P1176S2 P1176S3 P1176S4 P1176S5 P1176S6 P1176S7 P1176S9 P1176S10 P1176S11 P1176S12 REGION $time2 P1169S*P1174 P1172 P6020 P425 // 272 variables
	gen ANNO = "2016-2017"

	foreach i of numlist 1/8 {
		replace P1169S`i'=0 if P1169S`i'==2
	}	
	
	* Municipio
	gen MUNICIPIO = COD_DEPTO + COD_MPIO
	destring MUNICIPIO REGION, replace
	drop COD_MPIO COD_DEPTO

	save "${enut}/2016-2017/ENUT_1617.dta", replace
	
*******************************************
*** ENUT 2020-2021 ***
*******************************************

	/* A. Vuelvo las bases homogeneas
	import spss using "${enut}/2020-2021/CAP_I_2021.sav", clear
	rename *, upper
	save "${enut}/2020-2021/CAP_I_2021.dta", replace

	foreach i in B C D E G H1 {
		use "${enut}/2020-2021/CAP_`i'_2021.dta", clear
		rename *, upper
		save "${enut}/2020-2021/CAP_`i'_2021.dta", replace
	}

	import excel "${enut}/2020-2021/Dpto y Mpio_Geog_2020_2021.xlsx", sheet("Hoja1") firstrow clear
	save "${enut}/2020-2021/mun_2021.dta", replace

	* B. Pego las bases
	use "${enut}/2020-2021/cap_I_2021.dta", clear
	local data "D E G H1"
	foreach file of local data {
		merge 1:1 DIRECTORIO SECUENCIA_P ORDEN using "${enut}/2020-2021/cap_`file'_2021.dta", gen("`file'")
	}
	merge m:1 DIRECTORIO SECUENCIA_P using "${enut}/2020-2021/cap_C_2021.dta", gen(_merge7)
	merge m:1 DIRECTORIO using "${enut}/2020-2021/cap_B_2021.dta", gen(_merge6)
	merge m:1 DIRECTORIO using "${enut}/2020-2021/mun_2021.dta", gen(_merge7)
	*/

	import delimited "${enut}/2020-2021/BFENUTFINALANON.csv", clear
	rename *, upper

	* B. Pego las bases - no lo hago porque ya vienen pegadas
	* C. Cambio de nombre las variables para homogeneizar (Nombres de este año)
	* D. Me quedo con las variables de interés
	keep COD_MPIO COD_DEPTO DIRECTORIO SECUENCIA_P ORDEN P7310 P1152 P6090 P6020 P6040 P6210 P425 P1176S1 P1176S2 P1176S3 P1176S4 P1176S5 P1176S6 P1176S7 P1176S9 P1176S10 P1176S11 P1176S12 REGION $mw $nw1 $nw2 $nw3 $ch P1136S7A1 P1136S7A2 $cu $otro $rep P1169S* P1174 P1172 P6020 P425 // 286 variables
	gen ANNO = "2020-2021"
	
	foreach i of numlist 1/8 {
		replace P1169S`i'=1 if P1169S`i'==2
		replace P1169S`i'=0 if P1169S`i'==3 | P1169S`i'==4
	}

	* Municipio
	tostring COD_MPIO COD_DEPTO, replace
	replace COD_MPIO = "0" + COD_MPIO if length(COD_MPIO) == 2
	replace COD_MPIO = "00" + COD_MPIO if length(COD_MPIO) == 1
	gen MUNICIPIO = COD_DEPTO + COD_MPIO
	destring MUNICIPIO REGION, replace
	drop COD_MPIO COD_DEPTO
		
	save "${enut}/2020-2021/ENUT_2021.dta", replace
	
*******************************************
*** UNIFIED DATABASE ***
*******************************************
	
	* A. Pegado de año
	use "${enut}/2012-2013/ENUT_1213.dta", replace
	append using "${enut}/2016-2017/ENUT_1617.dta"
	append using "${enut}/2020-2021/ENUT_2021.dta"

	* B. Paso todas las variables de minutos a horas
	foreach i in P1124S2A2 P1124S1A2 P1126S1A2 P1126S2A2 P1126S3A2 P1126S4A2 P1126S5A2 P1126S6A2 P1126S7A3 P1129S1A2 P1150S2 P1099S2 P6535S1A2 P6534S2 P1166S2A2 P1166S1A2 P1113S1A2 P1113S2A2 P1111S1A2 P1112S1A2 P1112S2A2 P1111S2A2 P1110S1A2 P1110S2A2 P1110S3A2 P1110S4A2 P1110S5A2 P1110S6A2 P1110S7A2 P1110S8A2 P1111S3A2 P1111S4A2 P1144S6A2 P1111S5A2 P1144S2A2 P1144S3A2 P1144S5A2 P1144S4A2 P1144S1A2 P1159S2 P1155S2 P1161S1A2 P1161S2A2 P1161S4A2 P1161S5A3 P1160S1A2 P1156S2 P1143S1A2 P1143S2A2 P1143S4A2 P1143S3A2 P1142S1A2 P1142S2A2 P1142S3A2 P1142S4A2 P1136S1A2 P1136S2A2 P1136S3A2 P1136S4A2 P1136S5A2 P1136S6A2 P1136S7A2 P1141S1A2 P1141S2A2 P1141S3A2 P1141S4A2 P1140S6A2 P1140S3A2 P1128S8A2 P1131S1A4 P1131S2A4 P1131S3A4 P1140S7A2 P1128S1A2 P1128S2A2 P1128S3A2 P1125S1A2 P1125S2A2 P1125S3A2 P1125S4A2 P1125S5A2 P1125S6A2 P1125S7A3 P6530S1A2 P1139S1A2 P1139S2A2 P1139S3A2 P1137S1A2 P1137S2A2 P1137S3A2 P1135S1A2 P1135S2A2 P1135S3A2 P1134S1A2 P1134S2A2 P1134S3A2 P1133S1A2 P1133S2A2 P1133S3A2 P1132S1A2 P1132S2A2 P1132S3A2 P1131S1A2 P1131S2A2 P1131S3A2 P1114S1A2 P1114S2A2 P1114S3A2 P1114S4A2 P1128S4A2 P1128S5A2 P1128S6A2 P1128S7A2 P1127S1A2 P1127S3A2 P1127S4A2 P1127S2A2 P1122S1A3 P1122S2A3 P1122S3A3 P1121S1E P1121S2E P1121S3E P1140S5A2 P1140S4A2 P1140S2A2 P1140S1A2 P1153S3A2 P1153S6A2 P1153S5A2 P1153S4A2 P1153S2A2 P1153S1A2 {
		replace `i'=`i'/60
	}

	* Estandarizando a 24h
		egen TOT = rowtotal($mw $nw1 $nw2 $nw3 $ch $cu $otro P1129S1A1 P1129S1A2)
		foreach i in $mw $nw1 $nw2 $nw3 $ch $cu $otro P1129S1A1 P1129S1A2 {
			replace `i' = (24*`i')/TOT
		}
		drop if TOT == 0
		
	save "${enut}/ENUT_TOTAL.dta", replace
